networks:
  koordenet:
    driver: bridge

services:
  bootstrap:
    image: flaviosimonelli/koorde-node:netem
    env_file:
      - common_node.env
    environment:
      - BOOTSTRAP_PEERS=
      - CACHE_ENABLED=true
    ports:
      - "4000:4000"   # gRPC
      - "8080:8080"   # HTTP Cache API
    networks:
      - koordenet
    restart: always

  node:
    image: flaviosimonelli/koorde-node:netem
    env_file:
      - common_node.env
    environment:
      - BOOTSTRAP_PEERS=bootstrap:4000
      - CACHE_ENABLED=true
    ports:
      - "4000"  # gRPC (dynamic)
      - "8080"  # HTTP Cache API (dynamic)
    networks:
      - koordenet
    depends_on:
      - bootstrap
    restart: unless-stopped

  tester:
    image: flaviosimonelli/koorde-tester:latest
    depends_on:
      - bootstrap
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - SIM_DURATION=${SIM_DURATION}
      - QUERY_RATE=${QUERY_RATE}
      - QUERY_PARALLELISM_MIN=${QUERY_PARALLELISM_MIN}
      - QUERY_PARALLELISM_MAX=${QUERY_PARALLELISM_MAX}
      - QUERY_TIMEOUT=${QUERY_TIMEOUT}
      - DOCKER_SUFFIX=${DOCKER_SUFFIX}
    env_file:
      - tester.env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:z
      - ./results:/data/results:z
    user: "0:0"
    networks:
      - koordenet